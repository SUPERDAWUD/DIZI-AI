<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DIZI Chatbot</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>
    // Minimal fallback: ensure Start works even if later scripts fail
    function safeStartChat(){
      try{
        var el = document.getElementById('username-input');
        var name = (el && el.value) ? el.value.trim() : '';
        if(!name) return;
        window.USER = name.charAt(0).toUpperCase() + name.slice(1);
        var ov = document.getElementById('username-overlay');
        if (ov) ov.style.display = 'none';
        if (typeof window.startChat === 'function'){
          try { window.startChat(); } catch(e) {}
        }
      }catch(e){}
    }
  </script>
  <script src="{{ url_for('static', filename='main.js') }}"></script>
</head>
<body>
  <!-- Name overlay -->
  <div id="username-overlay" class="overlay">
    <div class="popup">
      <input type="text" id="username-input" placeholder="Enter your name" />
      <button onclick="safeStartChat()">Start</button>
    </div>
  </div>

  <!-- Main chat container -->
  <div class="chat-container">
    <h1>DIZI Chatbot</h1>
    <div id="chat-box" class="chat-box"></div>
    <div id="bot-loader">
      <span class="loader"></span><span> DIZI is thinking...</span>
    </div>
    <div id="stream-tools" style="display:none;text-align:center;margin:6px 0;">
      <button id="stop-btn-inline" onclick="stopStreaming()" style="padding:4px 8px;font-size:13px;">Stop generating</button>
    </div>
    <div class="input-area">
      <textarea id="user-input" placeholder="Type your message..." rows="1" style="resize:vertical"></textarea>
      <label style="margin-left:8px;color:#7fd957;"><input type="checkbox" id="stream-toggle" checked/> Stream</label>
      <label style="margin-left:8px;color:#7fd957;"><input type="checkbox" id="auto-continue"/> Auto-continue</label>
      <button id="send-btn" onclick="sendMessage()">Send</button>
      <button id="stop-btn" onclick="stopStreaming()" style="margin-left:8px;display:none;">Stop generating</button>
      <button id="regen-btn" onclick="regenerateLast()" style="margin-left:8px;">Regenerate</button>
    </div>
    <div id="translate-tools" style="margin-top:6px;display:flex;align-items:center;gap:6px;">
      <select id="translate-target">
        <option value="en" selected>English</option>
        <option value="es">Spanish</option>
        <option value="fr">French</option>
        <option value="de">German</option>
        <option value="ar">Arabic</option>
        <option value="zh">Chinese</option>
        <option value="ja">Japanese</option>
      </select>
      <button onclick="translateLast()">Translate last reply</button>
    </div>
    <div id="prompt-suggestions" style="margin-top:8px; display:flex; flex-wrap:wrap; gap:6px;"></div>

    <!-- File upload section -->
    <div class="file-upload-section">
      <form id="file-upload-form" enctype="multipart/form-data" method="post" action="/upload">
        <input type="file" id="file-input" name="file" style="display:none;" onchange="document.getElementById('file-name').textContent = this.files[0]?.name || ''">
        <button type="button" onclick="document.getElementById('file-input').click()">Choose File</button>
        <span id="file-name"></span>
        <button type="submit">Add</button>
      </form>
      <!-- Quick Web Summarization -->
      <div class="file-upload-section" style="margin-top:0.5em;">
        <input type="text" id="quick-url" placeholder="Paste a URL to summarize (optional)" style="width:70%"/>
        <button type="button" onclick="quickSummarize()">Summarize URL</button>
      </div>
    </div>

    <!-- Dev Mode button -->
    <div class="dev-mode-section" style="margin-top:1em; text-align:right;">
      <a href="/dev"><button id="dev-mode-btn" style="background:#222;color:#fff;padding:0.5em 1em;border-radius:5px;">Dev Mode</button></a>
    </div>

    <div style="margin-top:1em;text-align:center;">
      <button id="save-chat-btn" style="background:#7fd957;color:#222;padding:0.5em 1em;border-radius:5px;font-weight:bold;">Save This Chat</button>
      <button id="new-chat-btn" onclick="newChat()" style="margin-left:8px;background:#222;color:#7fd957;padding:0.5em 1em;border-radius:5px;">New Chat</button>
    </div>
  </div>

  <div class="sidebar" id="sidebar" style="position:fixed;left:0;top:0;bottom:0;width:240px;background:#181818;color:#fff;overflow-y:auto;padding:1em 0;z-index:10;display:flex;flex-direction:column;">
    <h3 style="text-align:center;">Previous Chats</h3>
    <ul id="chat-list" style="list-style:none;padding:0;margin:0;flex:1 1 auto;"></ul>
    <div style="margin-top:1em;">
      <label for="model-select" style="color:#7fd957;font-weight:bold;">Model</label>
      <select id="model-select" style="width:90%;margin-bottom:0.5em;">
        <option value="all">All-Around</option>
        <option value="performance">Performance (Best Quality)</option>
        <option value="fast">Fast (Best Speed)</option>
        <option value="code">Code Expert</option>
        <option value="math">Math Genius</option>
        <option value="chat">Conversationalist</option>
        <option value="bias">Bias GPT</option>
        <option value="oss">OSS GPT</option>
        <option value="super">Super Model (Best-of-All)</option>
        <option value="custom">Custom LLM (Powered by DIZI AI)</option>
      </select>
      <label for="personality-select" style="color:#7fd957;font-weight:bold;">Personality</label>
      <select id="personality-select" style="width:90%;">
        <option value="friendly">Friendly</option>
        <option value="formal">Formal</option>
        <option value="sarcastic">Sarcastic</option>
        <option value="creative">Creative</option>
        <option value="direct">Direct</option>
      </select>
      <button onclick="switchModel()" style="width:90%;margin-top:0.5em;background:#7fd957;color:#222;border:none;padding:8px 0;border-radius:6px;font-weight:bold;">Switch Model/Personality</button>
    </div>
  </div>
  <div style="margin-left:250px;">
    <div style="margin-top:1em;color:#7fd957;">
      <label><input type="checkbox" id="toggle-web"/> Auto Web Summarize</label><br/>
      <label><input type="checkbox" id="toggle-rag"/> Use Vector RAG</label>
    </div>
  </div>

  <script>
    let USER = null;
    let chatHistory = [];
    let editingIndex = null;
    let lastUserMsg = null;
    let currentStreamController = null;

    function startChat() {
      const input = document.getElementById('username-input');
      const name = input.value.trim();
      if (!name) return;
      USER = name.charAt(0).toUpperCase() + name.slice(1);
      document.getElementById('username-overlay').style.display = 'none';
      // Load remote sessions
      try { loadRemoteSessions(); } catch(e){}
    }
    // Allow Enter to confirm name
    (function(){
      const el = document.getElementById('username-input');
      if (el) el.addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); startChat(); } });
    })();

    async function loadRemoteSessions(){
      try {
        const res = await fetch('/api/load_chat', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user: USER }) });
        const data = await res.json();
        if (data && data.success && Array.isArray(data.history)){
          const imported = data.history.map((h,i)=>({ id: h.timestamp || (Date.now()+i), title: ((h.chat&&h.chat[0]&&h.chat[0].text)||'Imported Chat').slice(0,30), messages: (h.chat||[]) }));
          sessions = imported.concat(sessions||[]);
          saveSessions(); renderSessionList();
        }
      } catch(e){}
    }
    // Basic prompt suggestions (keep strings simple to avoid JS parse issues)
    const SUGGESTIONS = [
      'Summarize this URL: https://example.com',
      'Explain a Python Fibonacci function',
      'Give me 3 app ideas in AI',
      'Write a polite job follow-up email',
      'Create a 30-day Python study plan'
    ];
    (function renderSuggestions(){
      const c = document.getElementById('prompt-suggestions');
      c.innerHTML = '';
      SUGGESTIONS.forEach(s => {
        const b = document.createElement('button');
        b.textContent = s.length>40? (s.slice(0,40)+'â€¦'): s; b.title=s;
        b.onclick = ()=>{ const i=document.getElementById('user-input'); i.value = s; i.focus(); };
        c.appendChild(b);
      });
    })();

    function newChat(){
      const box = document.getElementById('chat-box');
      box.innerHTML = '';
      chatHistory = [];
      currentSession = createSession();
    }

    async function sendMessage() {
      const input = document.getElementById('user-input');
      const msg = input.value.trim();
      if (!msg || !USER) return;
      lastUserMsg = msg;
      if (editingIndex !== null) {
        // Replace the existing user message and drop anything after it
        chatHistory[editingIndex] = { role: 'user', text: msg, edited: true };
        chatHistory = chatHistory.slice(0, editingIndex + 1);
        // Re-render up to edit index
        const box = document.getElementById('chat-box');
        box.innerHTML = '';
        for (let i = 0; i < chatHistory.length; i++) {
          const m = chatHistory[i];
          appendMessage(m.role === 'user' ? 'You' : 'DIZI', m.text, null, i);
        }
      } else {
        chatHistory.push({ role: 'user', text: msg });
        appendMessage('You', msg, null, chatHistory.length - 1);
      }
      try { currentSession.messages = chatHistory.slice(); saveSessions(); syncCurrentSession(); } catch(e){}
      editingIndex = null;
      input.value = '';
      document.getElementById('bot-loader').style.display = 'block';
      const streaming = document.getElementById('stream-toggle')?.checked;
      if (streaming) {
        document.getElementById('stop-btn').style.display = 'inline-block';
        document.getElementById('stream-tools').style.display = 'block';
        await sendMessageStream(msg);
        document.getElementById('bot-loader').style.display = 'none';
        document.getElementById('stop-btn').style.display = 'none';
        document.getElementById('stream-tools').style.display = 'none';
        return;
      }
      const res = await fetch('/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user: USER, message: msg, web: document.getElementById('toggle-web')?.checked, rag: document.getElementById('toggle-rag')?.checked })});
      const data = await res.json();
      document.getElementById('bot-loader').style.display = 'none';
      let botContent = data.response;
      let followup = null;
      if (typeof botContent === 'object' && botContent !== null) {
        botContent = botContent.content || '';
        followup = data.response.followup || null;
        if (data.response.type === 'code' && data.response.content) {
          const lang = data.response.language || '';
          botContent = '```' + lang + '\n' + data.response.content + '\n```';
        }
      }
      chatHistory.push({ role: 'assistant', text: botContent });
      appendMessage('DIZI', botContent, followup, chatHistory.length - 1);
      addFollowups(botContent);
      try { currentSession.messages = chatHistory.slice(); saveSessions(); } catch(e){}
      // Auto-title on first user message
      try { if (!currentSession.title && chatHistory.length>=2) { currentSession.title = (chatHistory[0].text||'').slice(0,30)||'New Chat'; saveSessions(); renderSessionList(); } } catch(e){}
      // Auto-continue if enabled and truncated
      try { const ac = document.getElementById('auto-continue')?.checked; if (ac && isTruncated(botContent)) { lastUserMsg='Continue.'; await sendMessage(); } } catch(e){}
    }

    async function sendMessageStream(msg) {
      currentStreamController = new AbortController();
      const res = await fetch('/chat/stream', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user: USER, message: msg, web: document.getElementById('toggle-web')?.checked, rag: document.getElementById('toggle-rag')?.checked }), signal: currentStreamController.signal });
      const reader = res.body.getReader();
      const decoder = new TextDecoder('utf-8');
      let acc = '';
      let meta = null;
      let content = '';
      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value, { stream: true });
        acc += chunk;
        const parts = acc.split('\n\n');
        acc = parts.pop();
        for (const p of parts) {
          if (p.startsWith('data: ')) {
            const json = p.slice(6);
            try {
              const obj = JSON.parse(json);
              if (obj.meta) meta = obj.meta;
              if (obj.delta) content += obj.delta;
              if (obj.done) {
                const follow = meta && meta.followup ? meta.followup : null;
                chatHistory.push({ role: 'assistant', text: content });
                appendMessage('DIZI', content, follow, chatHistory.length - 1);
                addFollowups(content);
                content = '';
                try { currentSession.messages = chatHistory.slice(); saveSessions(); syncCurrentSession(); } catch(e){}
                try { const ac = document.getElementById('auto-continue')?.checked; if (ac && isTruncated(content)) { lastUserMsg='Continue.'; await sendMessage(); } } catch(e){}
              }
            } catch (e) {}
          }
        }
      }
    }

    function stopStreaming() {
      try { if (currentStreamController) currentStreamController.abort(); } catch (e) {}
      document.getElementById('stop-btn').style.display = 'none';
      document.getElementById('bot-loader').style.display = 'none';
      document.getElementById('stream-tools').style.display = 'none';
    }

    async function regenerateLast() {
      if (!lastUserMsg) return;
      const input = document.getElementById('user-input');
      input.value = lastUserMsg;
      await sendMessage();
    }

    async function translateLast(){
      // Find last assistant message
      let i = chatHistory.length - 1; let text = null;
      for (; i>=0; i--){ if (chatHistory[i].role==='assistant'){ text = chatHistory[i].text; break; } }
      if (!text) return;
      const target = document.getElementById('translate-target').value||'en';
      try {
        const res = await fetch('/api/translate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text, target }) });
        const data = await res.json();
        if (data && data.ok){
          const lbl = `Translation (${data.source || '?'} â†’ ${data.target || target}):\n`;
          appendMessage('DIZI', lbl + (data.translated||''), null, chatHistory.length);
          chatHistory.push({ role:'assistant', text: data.translated||'' });
        }
      } catch(e){}
    }

    function appendMessage(sender, text, followup, idx) {
      const chatBox = document.getElementById('chat-box');
      const messageDiv = document.createElement('div');
      messageDiv.className = sender === 'You' ? 'message user' : 'message bot';
      if (typeof idx === 'number') messageDiv.dataset.index = String(idx);
      // Edited indicator
      let editedTag = '';
      try { if (sender==='You' && typeof idx==='number' && chatHistory[idx] && chatHistory[idx].edited) { editedTag = " (edited)"; } } catch(e){}
      messageDiv.innerHTML = `<strong>${sender}:</strong>${editedTag} ${renderMarkdownLite(String(text))}`;
      const match = typeof text === 'string' ? text.match(/\/static\/generated\/[\S]+\.(png|jpg|jpeg)/g) : null;
      if (match) {
        match.forEach(url => {
          const img = document.createElement('img');
          img.src = url; img.alt = 'Generated image'; img.style.maxWidth = '100%'; img.style.marginTop = '10px';
          messageDiv.appendChild(document.createElement('br'));
          messageDiv.appendChild(img);
        });
      }
      // Add actions toolbar
      const actions = document.createElement('div');
      actions.style.fontSize = '0.85em';
      actions.style.marginTop = '4px';
      const copyBtn = document.createElement('button');
      copyBtn.textContent = 'Copy';
      copyBtn.style.marginRight = '6px';
      copyBtn.onclick = () => navigator.clipboard.writeText(typeof text === 'string' ? text : (text?.toString()||''));
      actions.appendChild(copyBtn);
      if (sender === 'You'){
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.onclick = () => { const i = document.getElementById('user-input'); i.value = typeof text==='string'?text:(text?.toString()||''); i.focus(); editingIndex = parseInt(messageDiv.dataset.index|| (chatHistory.length-1)); };
        actions.appendChild(editBtn);
      } else {
        const contBtn = document.createElement('button');
        contBtn.textContent = 'Continue';
        contBtn.onclick = () => { lastUserMsg = 'Continue.'; document.getElementById('user-input').value = 'Continue.'; sendMessage(); };
        actions.appendChild(contBtn);
      }
      messageDiv.appendChild(actions);

      chatBox.appendChild(messageDiv);
      try { if (window.hljs) window.hljs.highlightAll(); } catch (e) {}
      if (followup) {
        const followDiv = document.createElement('div');
        followDiv.className = 'followup';
        followDiv.style.color = '#7fd957';
        followDiv.style.marginLeft = '2em';
        followDiv.style.fontStyle = 'italic';
        followDiv.textContent = `Follow-up: ${followup}`;
        chatBox.appendChild(followDiv);
      }
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function escapeHtml(s){
      return s.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
    }
    function renderMarkdownLite(text){
      if (typeof text !== 'string') return text;
      const lines = text.split('\n');
      let inCode = false; let html = '';
      for (const line of lines){
        if (line.trim().startsWith('```')){ if (!inCode){ html += '<pre><code>'; inCode = true; } else { html += '</code></pre>'; inCode = false; } continue; }
        if (inCode){ html += escapeHtml(line) + '\n'; continue; }
        let l = escapeHtml(line).replace(/`([^`]+)`/g, '<code>$1</code>');
        l = l.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>').replace(/\*([^*]+)\*/g, '<em>$1</em>');
        html += l + '<br/>';
      }
      if (inCode) html += '</code></pre>';
      return html;
    }

    function isTruncated(text){
      if (!text) return false;
      const t = text.trim();
      if (t.endsWith('â€¦')) return true;
      if (/[.!?]$/.test(t)) return false;
      return t.length > 500;
    }

    // Local sessions (auto-title + rename)
    let sessions = JSON.parse(localStorage.getItem('dizi_chats')||'[]');
    let currentSession = sessions[0] || createSession();
    function createSession(){
      const s = { id: Date.now(), title: '', messages: [] };
      sessions.unshift(s); saveSessions(); renderSessionList(); return s;
    }
    function saveSessions(){ localStorage.setItem('dizi_chats', JSON.stringify(sessions)); }
    function renderSessionList(){
      const list = document.getElementById('chat-list'); list.innerHTML='';
      sessions.forEach(s=>{
        const li = document.createElement('li'); li.textContent = s.title || 'New Chat'; li.style.cursor='pointer';
        li.onclick = ()=>openSession(s.id);
        li.ondblclick = ()=>{ li.contentEditable = true; li.focus(); };
        li.onblur = ()=>{ s.title = li.textContent.trim()||s.title; saveSessions(); };
        list.appendChild(li);
      });
    }
    function openSession(id){
      const s = sessions.find(x=>x.id===id); if(!s) return; currentSession = s; chatHistory = s.messages.slice();
      const box = document.getElementById('chat-box'); box.innerHTML='';
      for (let i=0;i<chatHistory.length;i++){
        const m = chatHistory[i]; appendMessage(m.role==='user'?'You':'DIZI', m.text, null, i);
      }
    }
    renderSessionList();

    async function quickSummarize(){
      const url = document.getElementById('quick-url').value.trim(); if(!url) return;
      const res = await fetch('/api/web-summarize', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({url})});
      const data = await res.json();
      const sum = (data.result && data.result.summary) ? data.result.summary : (data.summary || JSON.stringify(data));
      appendMessage('DIZI', 'Summary:\n' + sum + (data.result && data.result.url ? ('\nSource: ' + data.result.url) : ''));
    }

    document.getElementById('save-chat-btn').onclick = async function(){
      if (!USER || !chatHistory.length) return alert('No chat to save!');
      await syncCurrentSession(true);
    }
    async function syncCurrentSession(showAlert){
      try{
        const res = await fetch('/api/save_chat', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user: USER, chat: chatHistory })});
        const result = await res.json();
        if (showAlert) alert(result.success ? ('Chat saved for user: ' + USER) : 'Failed to save chat.');
      }catch(e){ if (showAlert) alert('Failed to save chat.'); }
    }
    // Enter-to-send (Shift+Enter for newline)
    document.getElementById('user-input').addEventListener('keydown', (e)=>{
      if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
    });
    // Drag & Drop file upload with preview
    ;(function(){
      const area = document.querySelector('.chat-container');
      if (!area) return;
      ['dragenter','dragover','dragleave','drop'].forEach(evt=>{
        area.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); }, false);
      });
      area.addEventListener('drop', async (e)=>{
        const files = e.dataTransfer?.files; if (!files || !files.length) return;
        for (const file of files){
          const fd = new FormData(); fd.append('file', file);
          try{
            const r = await fetch('/upload', { method:'POST', body: fd });
            const j = await r.json();
            if (j && j.success){
              const name = j.filename || file.name; const url = '/download/' + (j.filename||'');
              appendMessage('You', 'Uploaded: ' + name + (j.filename? (' ('+url+')') : ''), null, chatHistory.length);
              chatHistory.push({ role:'user', text: 'Uploaded file: ' + name });
              if (file.type.startsWith('image/')){
                appendMessage('DIZI', 'Preview:\n' + `/download/${name}`, null, chatHistory.length);
              }
            } else {
              appendMessage('DIZI', 'Upload failed: ' + (j?.error||'Unknown'), null, chatHistory.length);
            }
          } catch(err){ appendMessage('DIZI', 'Upload error: ' + err, null, chatHistory.length); }
        }
      }, false);
    })();

    async function addFollowups(content){
      try {
        const res = await fetch('/api/followups', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ topic: content, n: 3 })});
        const data = await res.json();
        if (data && data.ok && Array.isArray(data.followups)){
          const box = document.getElementById('chat-box');
          const wrap = document.createElement('div');
          wrap.className = 'followup-suggestions';
          wrap.style.margin = '6px 0 10px 2em';
          data.followups.forEach(f => {
            const b = document.createElement('button');
            b.textContent = f; b.style.marginRight = '6px';
            b.onclick = () => { document.getElementById('user-input').value = f; sendMessage(); };
            wrap.appendChild(b);
          });
          box.appendChild(wrap);
          box.scrollTop = box.scrollHeight;
        }
      } catch (e) {}
    }
  </script>
</body>
</html>



